name: PR Check - Build and Test

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - develop
      - main
      - staging

jobs:
  validate:
    name: Validate PR Requirements
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
            build
          scopes: |
            api
            ui
            config
            docker
            ci
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            O t√≠tulo do PR deve come√ßar com letra min√∫scula e seguir o padr√£o:
            tipo(escopo): descri√ß√£o
            Exemplo: feat(ui): adiciona componente de usu√°rios

      - name: Check for secrets
        run: |
          echo "üîç Verificando se h√° secrets no c√≥digo..."
          if grep -rE "(password|secret|token|api_key|apikey)\s*=\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.js" --include="*.json" src/ docker/ 2>/dev/null | grep -v "example" | grep -v "test"; then
            echo "‚ö†Ô∏è  Poss√≠veis secrets encontrados no c√≥digo!"
            echo "Por favor, remova secrets e use vari√°veis de ambiente"
            exit 1
          else
            echo "‚úÖ Nenhum secret encontrado"
          fi

      - name: Check for .env files
        run: |
          echo "üîç Verificando arquivos .env..."
          if find . -name ".env*" -not -name ".env.example" | grep -q .; then
            echo "‚ùå Arquivos .env encontrados no reposit√≥rio!"
            echo "Por favor, remova arquivos .env e use apenas .env.example"
            exit 1
          else
            echo "‚úÖ Nenhum arquivo .env encontrado"
          fi

      - name: Validate Dockerfile
        run: |
          echo "üîç Validando Dockerfile..."
          if [ -f "docker/Dockerfile" ]; then
            if grep -iE "(password|secret|token)" docker/Dockerfile | grep -v "#" | grep -v "ENV"; then
              echo "‚ö†Ô∏è  Poss√≠veis secrets no Dockerfile!"
              exit 1
            fi
            echo "‚úÖ Dockerfile validado"
          fi

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:ci

      - name: Check coverage threshold
        run: |
          # Verifica se a cobertura est√° acima de 70%
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(grep -oP 'lines.*: \K[0-9.]+' coverage/lcov.info | head -1 || echo "0")
            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "‚ö†Ô∏è  Cobertura de testes abaixo de 70% (atual: ${COVERAGE}%)"
              echo "Por favor, adicione mais testes antes de fazer merge"
              exit 1
            else
              echo "‚úÖ Cobertura de testes OK (>= 70%): ${COVERAGE}%"
            fi
          else
            echo "‚ö†Ô∏è  Arquivo de coverage n√£o encontrado"
            exit 1
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [validate, lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:prod

      - name: Build Docker image (test)
        run: |
          docker build -t fed-fale-com-jesus-test:${{ github.sha }} -f docker/Dockerfile .

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const validateStatus = '${{ needs.validate.result }}' === 'success' ? '‚úÖ' : '‚ùå'
            const lintStatus = '${{ needs.lint.result }}' === 'success' ? '‚úÖ' : '‚ùå'
            const testStatus = '${{ needs.test.result }}' === 'success' ? '‚úÖ' : '‚ùå'
            const buildStatus = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå'
            
            const body = `## PR Check - Resultados
            
            ### Valida√ß√µes
            - Valida√ß√£o de t√≠tulo: ${validateStatus}
            - Verifica√ß√£o de secrets: ${validateStatus}
            - Verifica√ß√£o de .env: ${validateStatus}
            - Valida√ß√£o de Dockerfile: ${validateStatus}
            
            ### C√≥digo
            - Lint: ${lintStatus}
            - Testes unit√°rios: ${testStatus}
            - Coverage >= 70%: ${testStatus}
            - Build da aplica√ß√£o: ${buildStatus}
            
            ${buildStatus === '‚úÖ' && validateStatus === '‚úÖ' && lintStatus === '‚úÖ' && testStatus === '‚úÖ' ? '‚úÖ **Tudo OK! PR pronto para review.**' : '‚ùå **Por favor, corrija os problemas identificados antes de fazer merge.**'}`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
